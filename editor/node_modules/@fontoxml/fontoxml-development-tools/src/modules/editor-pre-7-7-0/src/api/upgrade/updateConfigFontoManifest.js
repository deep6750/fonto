import fs from 'fs-extra';

export default async (fontoManifestPath, addons) => {
	// Read the file.
	const fontoManifest = await fs.readJson(fontoManifestPath);

	// Add new dependencies.
	addons.forEach((addonName) => {
		if (!fontoManifest.dependencies[addonName]) {
			fontoManifest.dependencies[addonName] = `platform/${addonName}`;
		}
	});

	fontoManifest.dependencies = Object.keys(fontoManifest.dependencies)
		// Alphabetically sort the dependencies.
		.sort()
		// Filter out all platform add-ons not in the new add-ons list.
		.reduce((dependencies, oldDependency) => {
			const oldDependencyPath = fontoManifest.dependencies[oldDependency];
			if (
				!oldDependencyPath.startsWith('platform/') ||
				addons.includes(oldDependency) ||
				oldDependency === 'fontoxml-platform-base'
			) {
				dependencies[oldDependency] = oldDependencyPath;
			}

			return dependencies;
		}, Object.create(null));

	// Update the file.
	await fs.writeJson(fontoManifestPath, fontoManifest, {
		spaces: '\t',
	});
};
