import fs from 'fs-extra';
import path from 'path';

import executeAndLog from './api/executeAndLog.js';
import npmInstall from './api/npmInstall.js';

export default async function editorBuildCommand(req, res) {
	res.caption(req.command.getLongName());

	const editorPath = req.fdt.editorRepository.path;

	try {
		await fs.access(
			path.join(editorPath, 'node_modules'),
			fs.constants.R_OK
		);
	} catch (_error) {
		// npm install.
		await npmInstall(editorPath, res);
	}

	const options = [];
	if (req.options['no-mangle']) {
		options.push('--no-mangle');
	}

	try {
		await executeAndLog(
			res,
			'npm',
			['run', 'build', '--', ...options],
			editorPath,
			true,
			true
		);
	} catch (error) {
		throw new res.ErrorWithInnerError(
			'Build process stopped unexpectedly.',
			error
		);
	}
}
