import path from 'path';

import EditorRepository from '../../../EditorRepository.js';

const SCHEMA_COMPILE_DOCUMENTATION_URL =
	'https://documentation.fontoxml.com/latest/create-a-schema-bundle-d186eeb79200';

export default (moduleRegistration, schemaCommand, editorPre770ModulePath) => {
	const schemaCompileCommand = schemaCommand
		.addCommand(
			'compile',
			path.resolve(
				editorPre770ModulePath || moduleRegistration.getPath(),
				'src',
				'command.schema.compile.controller.js',
			),
		)
		.setDescription(
			'Compile a XSD schema to a schema format which can be used by Fonto Editor.'
		)
		.setLongDescription(
			`See the documentation for help with compiling a schema at ${SCHEMA_COMPILE_DOCUMENTATION_URL}`
		)

		.setRequiresLicenseValidation()
		.addRequiredProductLicenses(['editor'])

		.addParameter(
			'input',
			'The path where the schema bundle, in XSD format and a fonto.json file, is located. Uses the current directory if not specified.'
		)

		.addOption(
			'editor-path',
			undefined,
			'The path where the editor is located. Uses the current directory if not specified.'
		)

		.addOption(
			'overwrite',
			undefined,
			'Overwrite existing compiled schema files if they exist, without prompting.'
		)

		.addHiddenOption(
			'base-url',
			undefined,
			'Specify the schema compiler backend base url. By default it uses the url based on the FDT version or --version option.'
		)

		.addOption(
			'version',
			undefined,
			`The version of Fonto Editor to compile the schema for, which defaults to the same version as FDT. Can be either a specific version within the same minor range of the current FDT version, or a "nightly" version. Be warned: nightly can be unstable or may not work at all.`
		)

		.addExample(
			`${moduleRegistration.getAppInfo().name} editor schema compile`,
			'Compiled a schema from the current directory to either the current directory or in the appropriate editor packages for a Fonto Editor instance using the version matching the current FDT version.'
		)
		.addExample(
			`${
				moduleRegistration.getAppInfo().name
			} editor schema compile path/to/schema`,
			'Compile a schema from the specified path to either the current directory or in the appropriate editor packages for a Fonto Editor instance using the version matching the current FDT version.'
		)
		.addExample(
			`${
				moduleRegistration.getAppInfo().name
			} editor schema compile --overwrite`,
			'Compile a schema from the current directory to either the current directory or in the appropriate editor packages, skipping the confirmation prompt to overwrite files if the exist.'
		);

	EditorRepository.registerOverrideForCommand(schemaCompileCommand, (req) => {
		return {
			location: req.options['editor-path'],
		};
	});
};
