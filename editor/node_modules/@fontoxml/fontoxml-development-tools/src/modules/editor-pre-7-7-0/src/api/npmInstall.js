import fs from 'fs-extra';
import path from 'path';

import executeAndLog from './executeAndLog.js';

export default async function npmInstall(currentWorkingDirectoryPath, res) {
	try {
		await fs.access(
			path.join(currentWorkingDirectoryPath, 'package.json'),
			fs.constants.F_OK
		);
	} catch (_error) {
		// Skip npm install when there is no package.json file.
		return;
	}

	let destroySpinner;
	if (res) {
		destroySpinner = res.spinner('Installing dependencies...');
	}

	try {
		await executeAndLog(
			res,
			'npm',
			['install', '--silent'],
			currentWorkingDirectoryPath,
			false,
			false
		);
	} catch (error) {
		throw new res.ErrorWithInnerError(
			'Could not install dependencies. Try running "npm install" manually.',
			error
		);
	} finally {
		if (destroySpinner) {
			destroySpinner();
		}
	}
}
