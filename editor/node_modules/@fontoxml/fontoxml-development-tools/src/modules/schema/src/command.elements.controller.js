import createElementsTable from './api/createElementsTable.js';
import getClosestMatchingSchemaSummary from './api/getClosestMatchingSchemaSummary.js';

export default async function elementCommand(req, res) {
	res.caption(req.command.getLongName());

	req.fdt.editorRepository.throwIfNotInsideEditorRepository();

	const destroySpinner = res.spinner('Looking up schemas...');

	const schemaSummary = getClosestMatchingSchemaSummary(
		req.fdt.editorRepository.path,
		req.options.schema
	);

	destroySpinner();
	res.break();

	const table = await createElementsTable(req.command.getModuleRegistration());
	table.print(
		res,
		req.options.columns,
		schemaSummary.getAllElements().filter((element) => {
			if (!req.options['blacklist-ns'].length) {
				return true;
			}

			const ns = element.getNamespace();

			if (!ns) {
				return true;
			}

			return req.options['blacklist-ns'].indexOf(ns) === -1;
		}),
		req.options.sort,
		req.options.export
	);
}
