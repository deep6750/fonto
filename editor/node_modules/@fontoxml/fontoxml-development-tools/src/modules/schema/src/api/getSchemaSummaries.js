import fastGlob from 'fast-glob';
import path from 'path';

import SchemaSummary from './SchemaSummary.js';

export default function getSchemaSummaries(p) {
	const basePath = path.resolve(p);

	return fastGlob
		.sync(
			[
				// Traditional schema files compiled in a build
				'packages/**/schema.json',
				'packages-shared/**/schema.json',

				// Lazy loaded schema files
				'packages/**/assets/schemas/*.json',
				'packages-shared/**/assets/schemas/*.json',
			],
			{ cwd: basePath }
		)
		.filter(function (val, i, results) {
			const packageName = val.split('/').slice(0, 2).join('/');
			return (
				results.findIndex(
					(otherVal) =>
						packageName ===
						otherVal.split('/').slice(0, 2).join('/')
				) === i
			);
		})
		.map(
			(schemaPath) => new SchemaSummary(path.join(basePath, schemaPath))
		);
}
