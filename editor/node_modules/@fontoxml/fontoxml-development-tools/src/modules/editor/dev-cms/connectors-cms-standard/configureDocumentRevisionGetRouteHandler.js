import correlationIdRepository from './correlationIdRepository.js';

export default function configureDocumentRevisionGetRouteHandler() {
	return (req, res) => {
		const { documentId, revisionId } = req.query;
		// Because these requests do not originate from the editor, but from an other server, we
		// have no edit session token.  We do, however, have an correlationId which we may resolve
		// to the editSessionToken used by the corresponding call to the proxy
		const editSessionToken =
			correlationIdRepository.getEditSessionTokenForRequest(req);
		req.cms.loadRevision(
			documentId,
			revisionId,
			editSessionToken,
			(error, content) => {
				if (error) {
					if (error.status === 404) {
						res.status(404).end();
					} else {
						res.status(500).end();
					}
					return;
				}

				res.status(200)
					.set('content-type', 'application/json; charset=utf-8')
					.json({ content });
			}
		);
	};
}
