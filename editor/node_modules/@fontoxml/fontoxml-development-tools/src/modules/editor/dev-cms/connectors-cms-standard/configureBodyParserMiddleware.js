import bodyParser from 'body-parser';
import { match } from 'path-to-regexp';

/**
 * Body parser middleware.
 *
 * @param {Object} config
 *
 * @return {function(req, res, next)}
 */
export default (config) => {
	const pathsToExclude = ['/connectors/cms/standard/proxy/:proxyName'].concat(
		config.bodyParserMiddlewareExcludePaths || [],
	);
	const pathsToExcludeMatch = match(pathsToExclude, {
		end: false,
	});

	const jsonBodyParser = bodyParser.json({
		limit: config.bodyParserLimit,
	});

	return (req, res, next) => {
		if (pathsToExcludeMatch(req.path)) {
			next();
			return;
		}

		jsonBodyParser(req, res, next);
	};
};
