import multer from 'multer';
import os from 'os';
import { match } from 'path-to-regexp';

/**
 * Upload middleware for sending files to our routes.
 *
 * @param {Object} config
 *
 * @return {function(req, res, next)}
 */
export default (config) => {
	const pathsToExclude = ['/connectors/cms/standard/proxy/:proxyName'].concat(
		config.bodyParserMiddlewareExcludePaths || [],
	);
	const pathsToExcludeMatch = match(pathsToExclude, {
		end: false,
	});

	const upload = multer({
		dest: os.tmpdir(),
	}).any();

	return (req, res, next) => {
		if (pathsToExcludeMatch(req.path)) {
			next();
			return;
		}

		upload(req, res, next);
	};
};
