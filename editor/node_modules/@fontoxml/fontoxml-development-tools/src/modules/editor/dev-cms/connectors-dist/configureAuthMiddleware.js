import fs from 'fs';
import auth from 'http-auth';
import path from 'path';

import correlationIdRepository from '../connectors-cms-standard/correlationIdRepository.js';

/**
 * Basic authentication middleware.
 *
 * @param {Object} config
 *
 * @return {function(req, res, next)}
 */
export default (config) => {
	const passwordFilePath = path.join(config.root, 'users.htpasswd');
	if (config.distAuth && !fs.existsSync(passwordFilePath)) {
		throw new Error(
			'There should be a password file called "users.htpasswd" when running the editor in dist mode with basic authentication enabled.'
		);
	}

	const basicAuth = auth.basic({
		realm: 'Fonto Access Restricted',
		file: passwordFilePath,
	});

	return (req, res, next) => {
		// Determine if we can check auth based on a correlation id.
		if (!correlationIdRepository.canValidateRequest(req)) {
			basicAuth.check((_req, _res, error) =>
				error ? next(error) : next()
			)(req, res);
			return;
		}

		// Fonto correlation id auth
		correlationIdRepository
			.validateRequest(req)
			.then((passed) => {
				if (!passed) {
					basicAuth.check((_req, _res, error) =>
						error ? next(error) : next()
					)(req, res);
					return;
				}
				next();
			})
			.catch((error) => {
				next(error);
			});
	};
};
