import { parse, print } from 'recast';

export default function recastPlugin() {
	return {
		manipulateOptions(opts, _parserOpts) {
			opts.cloneInputAst = false;
		},
		parserOverride(code, opts, parser) {
			return parse(code, {
				...opts,
				parser: {
					parse: (source) => {
						return parser(source, {
							// Set options as usually done when using recast.
							allowImportExportEverywhere: true,
							allowReturnOutsideFunction: true,
							startLine: 1,
							ranges: true,

							// Recast needs the tokens.
							tokens: true,

							// parserOpts from babel transform.
							...opts,
						});
					},
				},
			});
		},
		generatorOverride(ast, opts) {
			return print(ast, {
				tabWidth: 4,
				...opts,
			});
		},
	};
};
