const moveComments = require('../astHelpers/moveComments.cjs');

module.exports = (babel, options, _cwd) => {
	const { types: t } = babel;

	return {
		visitor: {
			StringLiteral(path) {
				// Guard against string literals that aren't in an import declaration.
				if (!t.isImportDeclaration(path.getStatementParent())) {
					return;
				}

				const source = path.node.value;

				// Skip in case the source matches one of the entries in importAliases.
				// TODO: Maybe rewrite the text!. and json!. to a generic <loader>:. check.
				if (
					options.importAliases
						.map((alias) => alias.alias)
						.includes(source) ||
					!source.includes('/') ||
					source.includes('/src/') ||
					source.startsWith('.') ||
					source.startsWith('text!.') ||
					source.startsWith('json!.')
				) {
					return;
				}

				// Replace the first, and only the first, '/' with '/src/' to fix the path.
				const sourceNode = t.stringLiteral(
					source.replace('/', '/src/')
				);
				moveComments.asIs(babel, sourceNode, path.node);
				path.replaceWith(sourceNode);
			},
		},
	};
};
